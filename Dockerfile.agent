FROM node:24-alpine

# System deps for Chromium
RUN apk add --no-cache \
    #chromium \
    #nss \
    #font-liberation \
    #font-noto-cjk \
    #font-noto-emoji \
    git \
    ca-certificates \
    bash && \
    update-ca-certificates

RUN adduser \
   --disabled-password \
   --gecos "praktor user" \
   --home "/home/praktor" \
   --shell "/sbin/nologin" \
   --uid 10321 \
   praktor

# Install agent runner deps
WORKDIR /app
COPY agent-runner/package.json agent-runner/package-lock.json* ./
RUN npm ci 2>/dev/null || npm install
COPY agent-runner/src/ src/
COPY agent-runner/tsconfig.json .
RUN npx tsc && npm prune --production

# Add task CLI to PATH
RUN printf '#!/bin/sh\nexec node /app/dist/task-cli.js "$@"\n' > /usr/local/bin/ptask && chmod +x /usr/local/bin/ptask

# Pre-create volume mount points with correct ownership so Docker
# populates new named volumes with the right permissions and structure.
RUN mkdir -p /home/praktor/.claude/debug /workspace/group /workspace/global && \
    chown -R praktor:praktor /home/praktor/.claude /workspace/group /workspace/global

# Runtime config
ENV CHROMIUM_PATH=/usr/bin/chromium

USER praktor
WORKDIR /workspace/group
ENTRYPOINT ["node", "/app/dist/index.js"]
