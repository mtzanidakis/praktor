# Build ptask CLI
FROM golang:1.26-alpine AS ptask-builder
WORKDIR /src
COPY go.mod go.sum ./
RUN go mod download
COPY . .
RUN CGO_ENABLED=0 go build -o /ptask ./cmd/ptask

FROM node:24-alpine

# System deps for Chromium
RUN apk add --no-cache \
    #chromium \
    #nss \
    #font-liberation \
    #font-noto-cjk \
    #font-noto-emoji \
    git \
    ca-certificates \
    curl \
    bash && \
    update-ca-certificates

RUN adduser \
   --disabled-password \
   --gecos "praktor user" \
   --home "/home/praktor" \
   --shell "/sbin/nologin" \
   --uid 10321 \
   praktor

# Install Claude Code native binary
ARG TARGETARCH
RUN set -e; \
    if [ "$TARGETARCH" = "arm64" ]; then \
      URL="https://storage.googleapis.com/claude-code-dist-86c565f3-f756-42ad-8dfa-d59b1c096819/claude-code-releases/2.1.42/linux-arm64-musl/claude"; \
      CHECKSUM="85be36f185e18a9a0bd7abc84727b42e4ea98e549a3d73114c7eb37e8355fddc"; \
    else \
      URL="https://storage.googleapis.com/claude-code-dist-86c565f3-f756-42ad-8dfa-d59b1c096819/claude-code-releases/2.1.42/linux-x64-musl/claude"; \
      CHECKSUM="f92ed4b7999a0d564233260b1102c6ceedfd5174a40aea03ce1c9037fbbb0498"; \
    fi; \
    curl -fsSL -o /usr/local/bin/claude "$URL" && \
    echo "$CHECKSUM  /usr/local/bin/claude" | sha256sum -c - && \
    chmod +x /usr/local/bin/claude

# Install agent runner deps
WORKDIR /app
COPY agent-runner/package.json agent-runner/package-lock.json* ./
RUN npm ci 2>/dev/null || npm install
COPY agent-runner/src/ src/
COPY agent-runner/tsconfig.json .
RUN npx tsc && npm prune --production

# Add task CLI to PATH
COPY --from=ptask-builder /ptask /usr/local/bin/ptask

# Pre-create volume mount points with correct ownership so Docker
# populates new named volumes with the right permissions and structure.
RUN mkdir -p /home/praktor/.claude/debug /workspace/group /workspace/global && \
    chown -R praktor:praktor /home/praktor/.claude /workspace/group /workspace/global

# Runtime config
ENV CHROMIUM_PATH=/usr/bin/chromium

USER praktor
WORKDIR /workspace/group
ENTRYPOINT ["node", "/app/dist/index.js"]
