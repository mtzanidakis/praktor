# Build Go CLIs (ptask + getcc) and download Claude Code binary
FROM golang:1.26-alpine AS go-build
WORKDIR /src
COPY . .
RUN go mod download
RUN CGO_ENABLED=0 go build -o /ptask ./cmd/ptask
RUN CGO_ENABLED=0 go run ./cmd/getcc -save /claude

# Bundle agent runner with esbuild (no node_modules needed at runtime)
FROM node:24-alpine AS agent-builder
WORKDIR /app
COPY agent-runner/package.json agent-runner/package-lock.json* ./
RUN npm ci 2>/dev/null || npm install
COPY agent-runner/src/ src/
COPY agent-runner/tsconfig.json .
RUN npx esbuild --bundle --format=cjs --platform=node --target=node24 \
      --outfile=out/index.js src/index.ts && \
    npx esbuild --bundle --format=cjs --platform=node --target=node24 \
      --outfile=out/mcp-tasks.js src/mcp-tasks.ts && \
    npx esbuild --bundle --format=cjs --platform=node --target=node24 \
      --outfile=out/mcp-profile.js src/mcp-profile.ts && \
    npx esbuild --bundle --format=cjs --platform=node --target=node24 \
      --outfile=out/mcp-memory.js src/mcp-memory.ts && \
    npx esbuild --bundle --format=cjs --platform=node --target=node24 \
      --outfile=out/mcp-swarm.js src/mcp-swarm.ts

# Runtime image â€” no node_modules, just bundled JS files
FROM alpine:3.23

RUN apk add --no-cache \
    bash \
    ca-certificates \
    curl \
    git \
    jq \
    libgcc \
    libstdc++ \
    nix \
    nodejs \
    ripgrep \
    tzdata && \
    update-ca-certificates

# enable nix-command and flakes
RUN echo "extra-experimental-features = nix-command flakes" >> /etc/nix/nix.conf

RUN adduser \
   --disabled-password \
   --gecos "praktor user" \
   --home "/home/praktor" \
   --shell "/sbin/nologin" \
   --uid 10321 \
   praktor && \
   addgroup praktor nix

# Copy built artifacts from builder stages
COPY --from=agent-builder /app/out/ /app/
COPY --from=go-build /ptask /usr/local/bin/ptask
COPY --from=go-build /claude /usr/local/bin/claude

# Pre-create volume mount points with correct ownership so Docker
# populates new named volumes with the right permissions and structure.
RUN mkdir -p /workspace/agent /workspace/global && \
    chown -R praktor:praktor /workspace/agent /workspace/global && \
    chmod 0700 /home/praktor

# Runtime config
ENV USE_BUILTIN_RIPGREP=0
ENV NIX_PROFILES="/nix/var/nix/profiles/default /home/praktor/.nix-profile"
ENV NIX_SSL_CERT_FILE=/etc/ssl/certs/ca-certificates.crt
ENV PATH="/home/praktor/.nix-profile/bin:/nix/var/nix/profiles/default/bin:${PATH}"

USER praktor
WORKDIR /workspace/agent
ENTRYPOINT ["node", "/app/index.js"]
