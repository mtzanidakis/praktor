# Build Go CLIs (ptask + getcc) and download Claude Code binary
FROM golang:1.26-alpine AS go-build
WORKDIR /src
COPY . .
RUN go mod download
RUN CGO_ENABLED=0 go build -o /ptask ./cmd/ptask
RUN CGO_ENABLED=0 go run ./cmd/getcc -save /claude

# Install playwright-cli and extract its skill
FROM node:24-alpine AS playwright-cli
ENV PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=1
RUN npm install -g @playwright/cli@latest
# Install skills only, skip browser download (--config flag skips ensureConfiguredBrowserInstalled)
RUN mkdir -p /tmp/.playwright && cd /tmp && playwright-cli install --skills --config
# Verify skill was created
RUN test -f /tmp/.claude/skills/playwright-cli/SKILL.md

# Bundle agent runner with esbuild (no node_modules needed at runtime)
FROM node:24-alpine AS agent-builder
WORKDIR /app
COPY agent-runner/package.json agent-runner/package-lock.json* ./
RUN npm ci 2>/dev/null || npm install
COPY agent-runner/src/ src/
COPY agent-runner/tsconfig.json .
COPY agent-runner/esbuild.mjs .
RUN node esbuild.mjs

# Runtime image — no node_modules, just bundled JS files
FROM alpine:3.23

RUN apk add --no-cache \
    bash \
    ca-certificates \
    chromium \
    curl \
    git \
    jq \
    libgcc \
    libstdc++ \
    nix \
    nodejs \
    npm \
    ripgrep \
    ttf-freefont \
    font-noto-cjk \
    font-noto-emoji \
    tzdata && \
    update-ca-certificates

# enable nix-command and flakes
RUN echo "extra-experimental-features = nix-command flakes" >> /etc/nix/nix.conf

RUN adduser \
   --disabled-password \
   --gecos "praktor user" \
   --home "/home/praktor" \
   --shell "/sbin/nologin" \
   --uid 10321 \
   praktor && \
   addgroup praktor nix

# Copy built artifacts from builder stages
COPY --from=agent-builder /app/out/ /app/
COPY --from=go-build /ptask /usr/local/bin/ptask
COPY --from=go-build /claude /usr/local/bin/claude
COPY --from=playwright-cli /usr/local/lib/node_modules/@playwright /usr/local/lib/node_modules/@playwright
RUN ln -s ../lib/node_modules/@playwright/cli/playwright-cli.js /usr/local/bin/playwright-cli
COPY --from=playwright-cli /tmp/.claude/skills/playwright-cli/ /opt/playwright-cli/skill/
RUN echo '{"browser":{"browserName":"chromium","launchOptions":{"executablePath":"/usr/bin/chromium-browser","args":["--no-sandbox","--disable-gpu","--disable-dev-shm-usage"]}}}' \
    > /opt/playwright-cli/cli.config.json

# Pre-create volume mount points with correct ownership so Docker
# populates new named volumes with the right permissions and structure.
RUN mkdir -p /workspace/agent /workspace/global /home/praktor/bin && \
    chown -R praktor:praktor /workspace/agent /workspace/global /home/praktor/bin && \
    chmod 0700 /home/praktor

# playwright-cli env vars (skip browser download — we use system chromium)
ENV PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=1
ENV PLAYWRIGHT_BROWSERS_PATH=/usr/bin

# Runtime config
ENV USE_BUILTIN_RIPGREP=0
ENV NIX_PROFILES="/nix/var/nix/profiles/default /home/praktor/.nix-profile"
ENV NIX_SSL_CERT_FILE=/etc/ssl/certs/ca-certificates.crt
ENV PATH="/home/praktor/bin:/home/praktor/.nix-profile/bin:/nix/var/nix/profiles/default/bin:${PATH}"

USER praktor
WORKDIR /workspace/agent
ENTRYPOINT ["node", "/app/index.mjs"]
