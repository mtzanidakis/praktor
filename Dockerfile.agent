# Build Go CLIs (ptask + getcc) and download Claude Code binary
FROM golang:1.26-alpine AS go-build
WORKDIR /src
COPY . .
RUN go mod download
RUN CGO_ENABLED=0 go build -o /ptask ./cmd/ptask
RUN CGO_ENABLED=0 go run ./cmd/getcc -save /claude

# Bundle agent runner with esbuild (no node_modules needed at runtime)
FROM node:24-alpine AS agent-builder
WORKDIR /app
COPY agent-runner/package.json agent-runner/package-lock.json* ./
RUN npm ci 2>/dev/null || npm install
COPY agent-runner/src/ src/
COPY agent-runner/tsconfig.json .
RUN npx esbuild --bundle --format=cjs --platform=node --target=node24 \
      --outfile=out/index.js src/index.ts && \
    npx esbuild --bundle --format=cjs --platform=node --target=node24 \
      --outfile=out/mcp-server.js src/mcp-server.ts

# Runtime image â€” no node_modules, just bundled JS files
FROM alpine:3.23

RUN apk add --no-cache \
    bash \
    ca-certificates \
    chromium \
    curl \
    font-liberation \
    font-noto-cjk \
    font-noto-emoji \
    git \
    libgcc \
    libstdc++ \
    nodejs \
    nss \
    ripgrep \
    tzdata && \
    update-ca-certificates

RUN adduser \
   --disabled-password \
   --gecos "praktor user" \
   --home "/home/praktor" \
   --shell "/sbin/nologin" \
   --uid 10321 \
   praktor

# Copy built artifacts from builder stages
COPY --from=agent-builder /app/out/ /app/
COPY --from=go-build /ptask /usr/local/bin/ptask
COPY --from=go-build /claude /usr/local/bin/claude

# Pre-create volume mount points with correct ownership so Docker
# populates new named volumes with the right permissions and structure.
RUN mkdir -p /home/praktor/.claude/debug /workspace/group /workspace/global && \
    chown -R praktor:praktor /home/praktor/.claude /workspace/group /workspace/global

# Runtime config
ENV CHROMIUM_PATH=/usr/bin/chromium
ENV USE_BUILTIN_RIPGREP=0

USER praktor
WORKDIR /workspace/group
ENTRYPOINT ["node", "/app/index.js"]
