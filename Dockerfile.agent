FROM node:24-alpine

# System deps for Chromium
RUN apk add --no-cache \
    chromium \
    nss \
    font-liberation \
    font-noto-cjk \
    font-noto-emoji \
    git \
    ca-certificates \
    su-exec \
    bash && \
    update-ca-certificates

# Install agent runner deps
WORKDIR /app
COPY agent-runner/package.json agent-runner/package-lock.json* ./
RUN npm ci 2>/dev/null || npm install
COPY agent-runner/src/ src/
COPY agent-runner/tsconfig.json .
RUN npx tsc && npm prune --production

# Add task CLI to PATH
RUN printf '#!/bin/sh\nexec node /app/dist/task-cli.js "$@"\n' > /usr/local/bin/ptask && chmod +x /usr/local/bin/ptask

# Ensure .claude dir exists with correct ownership
RUN mkdir -p /home/node/.claude && chown -R node:node /home/node/.claude

# Runtime config
ENV CHROMIUM_PATH=/usr/bin/chromium

# Entrypoint: fix ownership of mounted volumes, then drop to node user
WORKDIR /workspace/group
ENTRYPOINT ["sh", "-c", "chown -R node:node /home/node/.claude /workspace/group 2>/dev/null; exec su-exec node node /app/dist/index.js"]
